<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension">

   <!-- Upgrade code for all NLedger versions. Must be the same for all updates. -->
   <?define UpgradeCode="20E40538-6702-4A39-9901-1EC041653F73" ?>

   <!-- Product version - takes from exe file (four number file version) -->
   <?define VersionNumber="!(bind.FileVersion.File_NLedger_cli_exe)" ?>

   <!-- Help URL (used in Add/Remove programs) -->
   <?define InfoURL="https://github.com/dmitry-merzlyakov/nledger" ?>


   <!-- Product IDs must be autogenerated (*) in order to make major upgrades pass well -->
   <Product Id="*" UpgradeCode="$(var.UpgradeCode)" Name="!(loc.Product_Name)" Version="$(var.VersionNumber)" Manufacturer="!(loc.Product_Manufacturer)" Language="!(loc.Language)">
      <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" Description="!(loc.Product_Description)" Comments="!(loc.Package_Comments) $(var.VersionNumber)" />
      <Media Id="1" Cabinet="product.cab" EmbedCab="yes"/>

      <!-- Checking required .Net Framework version -->

      <PropertyRef Id="NETFRAMEWORK45"/>
      <Condition Message="!(loc.Condition_NetFrameworkIsNotInstalled)">
         <![CDATA[Installed OR NETFRAMEWORK45]]>
      </Condition>

      <!-- VBS custom actions  -->

      <Binary Id='InstallerScripts' SourceFile='InstallerScripts.vbs' />

      <!-- Checks installed Powershell version (4 or higher) -->

      <!-- Table of conditions - https://stackoverflow.com/questions/320921/how-to-add-a-wix-custom-action-that-happens-only-on-uninstall-via-msi -->
      <InstallExecuteSequence> 
         <Custom Action="GetPowershellVersion" Before ="InstallFiles">(NOT REMOVE) OR UPGRADINGPRODUCTCODE</Custom>  
         <Custom Action="ShowNoPowershellWarningMessage" Before ="InstallFiles">(PSVERSIONMAJOR &lt; 4) AND ((NOT REMOVE) OR UPGRADINGPRODUCTCODE) AND PowershellIsRequired</Custom>  
      </InstallExecuteSequence> 
      <SetProperty Id="NoPowershellWarningMessage" Value="!(loc.Condition_PowershellIsNotInstalled)" After="CostFinalize" />
      <SetProperty Id="PowershellIsRequired" Value="1" After="CostFinalize" >((&amp;SetupConsoleFeature=3) AND NOT(!SetupConsoleFeature=3)) OR ((&amp;LiveDemoFeature=3) AND NOT(!LiveDemoFeature=3)) OR ((&amp;TestToolkitFeature=3) AND NOT(!TestToolkitFeature=3)) OR ((&amp;ManualInstallFeature=3) AND NOT(!ManualInstallFeature=3))</SetProperty>
      <CustomAction Id='ShowNoPowershellWarningMessage' BinaryKey='InstallerScripts' VBScriptCall='ShowNoPowershellWarningMessage' />
      <CustomAction Id='GetPowershellVersion' BinaryKey='InstallerScripts' VBScriptCall='GetPowershellVersion' />
      
      <!-- Deletes user settings on uninstalling with user's confirmation -->

      <InstallExecuteSequence> 
         <Custom Action="DeleteUserSettings" After="InstallFinalize">(NOT UPGRADINGPRODUCTCODE) AND (REMOVE="ALL")</Custom>  
      </InstallExecuteSequence> 
      <SetProperty Id="DeleteUserSettingsQuestionText" Value="!(loc.Condition_DeleteUserSettings)" After="CostFinalize" />
      <CustomAction Id='DeleteUserSettings' BinaryKey='InstallerScripts' VBScriptCall='DeleteUserSettings' />

      <!-- UI Customization -->

      <WixVariable Id="WixUILicenseRtf" Value="$(var.PackageFolder)NLedger\LICENSE.rtf" />
      <!-- Extra messages on Exit dialog -->
      <Property Id="WIXUI_EXITDIALOGOPTIONALTEXT" Value="!(loc.ExitDialog_WelcomeText)" />
      <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="!(loc.ExitDialog_LaunchText)" />
      <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />
      <Property Id="WixShellExecTarget" Value="none" />
      <SetProperty Id="WixShellExecTarget" Value="[APPLICATIONFOLDER]README.html" After="CostFinalize" />
      <CustomAction Id="LaunchApplication" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes" />

      <!-- Images -->

      <WixVariable Id="WixUIBannerBmp" Value="Images\WixUIBanner.jpg" />
      <WixVariable Id="WixUIDialogBmp" Value="Images\WixUIDialog.jpg" />
      <Icon Id="Icon.exe" SourceFile="Images\WixUIIcon.ico" /> 
      <Property Id="ARPPRODUCTICON" Value="Icon.exe" />

      <!-- Upgrade definition -->

      <MajorUpgrade DowngradeErrorMessage="!(loc.NewerInstalled)" Schedule="afterInstallExecute" />

      <Property Id="ARPHELPLINK" Value="$(var.InfoURL)" />
 
      <!-- Dealing with files -->

      <Directory Id="TARGETDIR" Name="SourceDir">

         <!-- Add NLedger path to PATH variable -->

         <Component Id="AppBinFilesPath" Guid="9E3407D5-85A3-4922-A4DE-9BD66BF0FE27"  >
            <Environment Id="PATH" Name="PATH" Value="[APPLICATIONFOLDER]" Permanent="no" Part="last" Action="set" System="no" />
         </Component>

         <!-- Shortcuts -->

         <Directory Id="ProgramMenuFolder">
            <Directory Id="ProgramMenuSubfolder" Name=".Net Ledger">
                <Directory Id="DocumentationSubfolder" Name="Documentations">
                    <Component Id="DocumentationShortcuts" Guid="7FD04C72-CAB4-4A1D-B098-5A69D381D387" >
                        <RemoveFolder Id="DocumentationSubfolder" On="uninstall"/>
                        <RegistryValue Root="HKCU" Key="Software\Dmitry Merzlyakov\NLedger\DocumentationShortcuts" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
                    </Component>
                    <Component Id="LedgerDocShortcuts" Guid="145D5737-73E5-42D3-A292-8C1643A5B630" >
                        <Shortcut Id="LedgerDocShortcutLedger3Html" Name="Ledger 3 Documentation" Description="Ledger: Command-Line Accounting" Target="[APPLICATIONFOLDER]ledger3.html" WorkingDirectory="APPLICATIONFOLDER"/>
                        <Shortcut Id="LedgerDocShortcutLedger3Man" Name="Ledger 3 Man Page" Description="Man page of LEDGER" Target="[APPLICATIONFOLDER]ledger.1.html" WorkingDirectory="APPLICATIONFOLDER"/>
                        <RegistryValue Root="HKCU" Key="Software\Dmitry Merzlyakov\NLedger\LedgerDocShortcuts" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
                    </Component>
                    <Component Id="NLedgerDocShortcuts" Guid="1442D7CB-462F-47A1-91FA-76AE386B13E2" >
                        <Shortcut Id="NLedgerDocShortcutNLedgerHtml" Name=".Net Ledger Guide" Description=".Net Ledger Documentation" Target="[APPLICATIONFOLDER]nledger.html" WorkingDirectory="APPLICATIONFOLDER"/>
                        <Shortcut Id="NLedgerDocShortcutREADMEHtml" Name=".Net Ledger Readme" Description=".Net Ledger Release Notes" Target="[APPLICATIONFOLDER]README.html" WorkingDirectory="APPLICATIONFOLDER"/>
                        <RegistryValue Root="HKCU" Key="Software\Dmitry Merzlyakov\NLedger\NLedgerDocShortcuts" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
                    </Component>
                </Directory>
                <Component Id="ProgramMenuSubfolderShortcuts" Guid="F74D2881-317F-4559-97BF-29C23CBD4785" >
                    <RemoveFolder Id="ProgramMenuSubfolder" On="uninstall"/>
                    <RegistryValue Root="HKCU" Key="Software\Dmitry Merzlyakov\NLedger\ProgramMenuSubfolderShortcuts" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
                </Component>
                <Component Id="NLedgerFolderShortcuts" Guid="C14A9C6D-27EE-4DDB-BA13-D9E2BE4CFF36" >
                    <Shortcut Id="NLedgerFolderShortcut" Name=".Net Ledger Folder" Description="Ledger Application Folder" Target="[APPLICATIONFOLDER]" WorkingDirectory="APPLICATIONFOLDER"/>
                    <RegistryValue Root="HKCU" Key="Software\Dmitry Merzlyakov\NLedger\NLedgerFolderShortcut" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
                </Component>
                <Component Id="NLManagementSetupShortcuts" Guid="FD540361-9F4D-4021-A162-FE7FC9A0A400" >
                    <Shortcut Id="NLManagementSetupShortcut" Name=".Net Ledger Setup Console" Description=".Net Ledger Setup" Target="[APPLICATIONFOLDER]\NLManagement\NLSetup.Console.cmd" Icon="Icon.exe" WorkingDirectory="APPLICATIONFOLDER"/>
                    <RegistryValue Root="HKCU" Key="Software\Dmitry Merzlyakov\NLedger\NLManagementSetupShortcuts" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
                </Component>
                <Component Id="NLManagementLiveDemoShortcuts" Guid="D69B5A6C-9F1D-43F0-80B9-A42647260997" >
                    <Shortcut Id="NLManagementLiveDemoShortcut" Name=".Net Ledger Live Demo" Description=".Net Ledger Demonstration Console" Target="[APPLICATIONFOLDER]\NLManagement\NLDoc.LiveDemo.WebConsole.cmd" Icon="Icon.exe" WorkingDirectory="APPLICATIONFOLDER"/>
                    <RegistryValue Root="HKCU" Key="Software\Dmitry Merzlyakov\NLedger\NLManagementLiveDemoShortcuts" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
                </Component>
                <Component Id="NLTestToolkitShortcuts" Guid="CE693206-02C0-4BD6-A739-765CA306E936" >
                    <Shortcut Id="NLTestToolkitShortcut" Name=".Net Ledger Test Toolkit" Description=".Net Ledger Test Toolkit Console" Target="[APPLICATIONFOLDER]\NLTestToolkit\NLTest.cmd" Icon="Icon.exe" WorkingDirectory="APPLICATIONFOLDER"/>
                    <RegistryValue Root="HKCU" Key="Software\Dmitry Merzlyakov\NLedger\NLTestToolkitShortcut" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
                </Component>
            </Directory>
         </Directory>

      </Directory>

      <!-- Feature definitions -->

      <Feature Id="NLedgerFeature" Title="!(loc.NLedgerFeature_Title)" Level="1" Display="expand" Description="!(loc.NLedgerFeature_Desc)" ConfigurableDirectory="APPLICATIONFOLDER" AllowAdvertise="no" Absent="disallow" InstallDefault="local" >

         <!-- NLedger Core components (not optional) -->
         <ComponentRef Id="AppBinFiles"/>                      <!-- NLedger .Net Framework dll and exe files -->
         <ComponentRef Id="AppBinCoreFiles"/>                  <!-- NLedger .Net Core dll and exe files -->
         <ComponentRef Id="AppBinFilesPath"/>                  <!-- Adding NLedger folder to PATH -->
         <ComponentRef Id="LedgerManFiles"/>                   <!-- Ledger manual that can be open from NLedger -->
         <ComponentRef Id="LedgerCoreManFiles"/>               <!-- Ledger manual that can be open from NLedger Core -->
         <ComponentRef Id="LicenseFiles"/>                     <!-- License files -->
         <ComponentRef Id="Extras"/>                           <!-- Extras folder with samples for db calls -->
         <ComponentRef Id="NLedgerFolderShortcuts"/>           <!-- Adding a shortcut for NLedger folder -->
         <ComponentRef Id="ProgramMenuSubfolderShortcuts"/>    <!-- Common component to manage main menu folder with shortcuts -->
         <ComponentRef Id="NLedgerReleaseNotesFiles"/>         <!-- Release Notes (readme and changelog) that are open after install -->
         <ComponentRef Id="LedgerSharedTestFiles_input"/>      <!-- Example data files -->

         <Feature Id="DocFilesFeature" Title="!(loc.DocFilesFeature_Title)" Level="1" Description="!(loc.DocFilesFeature_Desc)" AllowAdvertise="no" >
           <ComponentRef Id="LedgerDocFiles"/>                 <!-- Ledger 3 Documentation -->
           <ComponentRef Id="NLedgerDocFiles"/>                <!-- NLedger short doc -->
           <ComponentRef Id="LedgerDocShortcuts"/>             <!-- Shortcuts -->
           <ComponentRef Id="NLedgerDocShortcuts"/>
           <ComponentRef Id="DocumentationShortcuts" />
         </Feature>

         <Feature Id="SetupConsoleFeature" Title="!(loc.SetupConsoleFeature_Title)" Level="1" Description="!(loc.SetupConsoleFeature_Desc)" AllowAdvertise="no" >
           <ComponentRef Id="NLManagementCommon"/>
           <ComponentRef Id="NLManagementSetup"/>
           <ComponentRef Id="NLManagementSetupShortcuts"/>
         </Feature>

         <Feature Id="LiveDemoFeature" Title="!(loc.LiveDemoFeature_Title)" Level="1" Description="!(loc.LiveDemoFeature_Desc)" AllowAdvertise="no" >
           <ComponentRef Id="NLManagementCommon"/>
           <ComponentRef Id="NLManagementLiveDemo"/>
           <ComponentRef Id="NLManagementLiveDemoShortcuts"/>
           <ComponentRef Id="SandboxTestFiles"/>
         </Feature>

         <!-- Test toolkit is disabled by default (Level=3) -->
         <Feature Id="TestToolkitFeature" Title="!(loc.TestToolkitFeature_Title)" Level="5" Description="!(loc.TestToolkitFeature_Desc)" AllowAdvertise="no" >
           <ComponentRef Id="LedgerTestFiles_manual"/>
           <ComponentRef Id="LedgerTestFiles_nledger"/>
           <ComponentRef Id="LedgerTestFiles_input"/>
           <ComponentRef Id="LedgerTestFiles_baseline"/>
           <ComponentRef Id="LedgerTestFiles_regress"/>
           <ComponentRef Id="NLTestToolkit"/>
           <ComponentRef Id="NLTestToolkitShortcuts"/>
         </Feature>

         <!-- Manual Install Scripts are disabled by default (Level=3) -->
         <Feature Id="ManualInstallFeature" Title="!(loc.ManualInstallFeature_Title)" Level="5" Description="!(loc.ManualInstallFeature_Desc)" AllowAdvertise="no" >
           <ComponentRef Id="ManualInstall"/>
         </Feature>

      </Feature>

      <UI>
	 <UIRef Id="WixUI_Mondo"/>
         <!-- Exit dialog action (show readme) -->
         <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchApplication">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
      </UI>

      <!-- Create a hard link (alias 'ledger') -->

      <SetProperty Id="AppBinFilesAddHardLink" Value='"[SystemFolder]cmd.exe" /C mklink /H "[APPLICATIONFOLDER]ledger.exe" "[APPLICATIONFOLDER]NLedger-cli.exe"' Sequence='execute' Before="AppBinFilesAddHardLink" />
      <SetProperty Id="AppBinFilesDelHardLink" Value='"[SystemFolder]cmd.exe" /C del /f /q "[APPLICATIONFOLDER]ledger.exe' Sequence='execute' Before="AppBinFilesDelHardLink" />

      <CustomAction Id='AppBinFilesAddHardLink' BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Impersonate="no" Return="ignore" /> 
      <CustomAction Id='AppBinFilesDelHardLink' BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Impersonate="no" Return="ignore" /> 

      <InstallExecuteSequence> 
         <Custom Action="AppBinFilesAddHardLink" Before="InstallFinalize">$AppBinFiles&gt;2</Custom>  
         <Custom Action="AppBinFilesDelHardLink" Before="MsiUnpublishAssemblies">$AppBinFiles=2</Custom>  
      </InstallExecuteSequence> 

   </Product>

</Wix>